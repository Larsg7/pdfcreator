import { Component, OnInit } from '@angular/core';
import { UserService } from '../../services/user.service';
import { Template } from '../../models/template.model';
import { AlertService } from '../../services/alert.service';
import { NewTemplateDialogComponent } from '../../dialogs/new-template-dialog/new-template-dialog.component';
import { ActivatedRoute, Router } from '@angular/router';
import { TemplateService } from '../../services/template.service';
import 'rxjs/add/observable/combineLatest';

@Component({
  selector: 'app-template-picker',
  templateUrl: './template-picker.component.html',
  styleUrls: ['./template-picker.component.scss']
})
export class TemplatePickerComponent implements OnInit {
  get currentTemplateId(): number {
    return this._currentTemplateId;
  }

  set currentTemplateId(id: number) {
    this.templateService.activeTemplate = this.templates.find(_ => _.id === id);
    this.nav.navigate(['/app', id]);
    this._currentTemplateId = id;
  }

  templates: Template[] = [];
  public _currentTemplateId: number;

  constructor(public userService: UserService,
              public alert: AlertService,
              private nav: Router,
              public templateService: TemplateService,
              private route: ActivatedRoute) {
    this.userService.templates.subscribe(templates => {
      this.templates = templates;
      if (route.firstChild) {
        route.firstChild.params.subscribe(params => {
          if (params) {
            this.currentTemplateId = +params['id'];
          }
        });
      }
      this.templateService.activeTemplateSub.subscribe(template => {
        this.updateTemplate(template);
      })
    });

  }

  ngOnInit() {
  }

  newTemplate() {
    this.alert.showDialog(NewTemplateDialogComponent, {}).then(id => {
      if (id) {
        this.nav.navigate(['/app', id]);
      }
    });
  }

  private updateTemplate(template: Template) {
    const index = this.templates.indexOf(this.templates.find(_ => _.id === template.id));
    if (index !== -1) {
      this.templates[index] = template;
    }
  }
}
